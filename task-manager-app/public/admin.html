<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="admin-panel">
      <h1>Admin Dashboard</h1>

      <table id="users-table">
        <thead>
        <tr>
        <th>ID</th>
        <th>Username</th>
        <th>Email</th>
        <th>Blocked</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>

    </tbody>
  </table>

  <div id="message"></div>
  </div>

<script>
  // Check token and role BEFORE doing anything else
  const token = localStorage.getItem('token'); 
  const role = localStorage.getItem('role');

  if (!token || role !== 'admin') {
    alert('Access denied. You must be an admin to view this page.');
    window.location.href = 'login.html';
  }

  const API_URL = 'http://localhost:5500';

  const messageDiv = document.getElementById('message');
  const usersTableBody = document.querySelector('#users-table tbody');

  function showMessage(text, type = 'success') {
    messageDiv.textContent = text;
    messageDiv.className = '';
    messageDiv.classList.add(type === 'success' ? 'success' : 'error');
    messageDiv.style.display = 'block';
    setTimeout(() => {
      messageDiv.style.display = 'none';
    }, 3000);
  }

  async function fetchUsers() {
    try {
      const res = await fetch(`${API_URL}/admin/users`, {
        headers: {
          'Authorization': `Bearer ${token}`,
        },
      });

      if (!res.ok) {
        throw new Error(`Failed to load users: ${res.statusText}`);
      }

      const users = await res.json();
      renderUsers(users);
    } catch (err) {
      showMessage(err.message, 'error');
    }
  }

  function renderUsers(users) {
    usersTableBody.innerHTML = '';

    users.forEach(user => {
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td>${user.id}</td>
        <td>${user.username}</td>
        <td>${user.email}</td>
        <td>${user.is_blocked ? 'Yes' : 'No'}</td>
        <td>
          <button class="${user.is_blocked ? 'unblock' : 'block'}" data-userid="${user.id}">
            ${user.is_blocked ? 'Unblock' : 'Block'}
          </button>
        </td>
      `;

      usersTableBody.appendChild(tr);
    });

    document.querySelectorAll('button.block, button.unblock').forEach(button => {
      button.addEventListener('click', handleBlockUnblock);
    });
  }

  async function handleBlockUnblock(event) {
    const button = event.target;
    const userId = button.getAttribute('data-userid');
    const block = button.classList.contains('block');

    if (!confirm(`Are you sure you want to ${block ? 'block' : 'unblock'} this user?`)) {
      return;
    }

    try {
      // const res = await fetch(`${API_URL}/admin/block/${userId}`, {
      //   method: 'PUT',
      //   headers: {
      //     'Content-Type': 'application/json',
      //     'Authorization': `Bearer ${token}`,
      //   },
      //   credentials: 'include', 
      //   body: JSON.stringify({ block }),
      // });
       const res = await fetch(`${API_URL}/admin/block/${userId}`, {
  method: 'PUT',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`,
  },
  // Remove credentials for now:
  // credentials: 'include',
  body: JSON.stringify({ block }),
});




      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.error || data.message || 'Failed to update user');
      }

      showMessage(data.message);
      fetchUsers();
    } catch (err) {
      showMessage(err.message, 'error');
    }
  }

  // Initial load
  fetchUsers();
</script>
</body>
</html>
























 







