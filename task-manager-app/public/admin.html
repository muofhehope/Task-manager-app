<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
      <div class="admin-panel">
       <h1>Admin Dashboard</h1>
        <button id="logoutBtn" class="btn">Logout</button>
     </div>

 <div class="admin-panel">

    <div class="admin-panel-flex">
      <div class="right-container">
      <section id="metrics-section">
      <h2>Metrics</h2>
      <div id="metrics">Loading metrics...</div>
     </section>
     </div>

  <!-- Recent Actions Section -->
  <div class="right-container">
    <section id="actions-section">
      <h2>Recent Actions</h2>
      <ul id="actions-list"></ul>
    </section>
  </div>

    </div>

    <div class="admin-panel">

    <!--  User Management Table -->
    <h2>All Users</h2>
    <table id="users-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Username</th>
          <th>Email</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="message"></div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirm-modal" class="modal hidden">
    <div class="modal-content">
      <span class="close" id="closeModal">&times;</span>
      <p id="confirm-text"></p>
      <button id="confirm-yes">Yes</button>
      <button id="confirm-no">Cancel</button>
    </div>
    </div>


    <!-- Remove Task Modal -->
<div id="remove-task-modal" class="modal hidden">
  <div class="modal-content">
    <span class="close" id="closeRemoveModal">&times;</span>
    <p id="remove-task-text">Are you sure you want to remove this task?</p>
    <form id="remove-task-form">
      <input type="hidden" id="remove-task-id" />
      <button type="submit" class="btn danger">Remove Task</button>
      <button type="button" id="cancelRemoveTask">Cancel</button>
    </form>
  </div>
</div>

   </div> 

  <script>
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role');

    if (!token || role !== 'admin') {
      alert('Access denied. You must be an admin to view this page.');
      window.location.href = 'login.html';
    }

    const API_URL = 'http://localhost:5500';
    const messageDiv = document.getElementById('message');
    const usersTableBody = document.querySelector('#users-table tbody');
    const logoutBtn = document.getElementById('logoutBtn');

    function showMessage(text, type = 'success') {
      messageDiv.textContent = text;
      messageDiv.className = '';
      messageDiv.classList.add(type === 'success' ? 'success' : 'error');
      messageDiv.style.display = 'block';
      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 3000);
    }

    async function fetchUsers() {
      try {
        const res = await fetch(`${API_URL}/admin/users`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error(`Failed to load users: ${res.statusText}`);

        const users = await res.json();
        renderUsers(users);
      } catch (err) {
        showMessage(err.message, 'error');
      }
    }

    function renderUsers(users) {
      usersTableBody.innerHTML = '';

      users.forEach(user => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${user.id}</td>
          <td>${user.username}</td>
          <td>${user.email}</td>
          <td>${user.is_blocked ? 'Blocked' : 'Active'}</td>
          <td>
            <button 
              class="${user.is_blocked ? 'unblock' : 'block'}" 
              data-userid="${user.id}" 
              data-username="${user.username}">
              ${user.is_blocked ? 'Unblock' : 'Block'}
            </button>
          </td>
        `;
        usersTableBody.appendChild(tr);
      });

      document.querySelectorAll('button.block, button.unblock').forEach(button => {
        button.addEventListener('click', handleBlockUnblock);
      });
    }

    function showConfirmModal(message) {
      return new Promise((resolve) => {
        const modal = document.getElementById('confirm-modal');
        const text = document.getElementById('confirm-text');
        const yesBtn = document.getElementById('confirm-yes');
        const noBtn = document.getElementById('confirm-no');
        const closeBtn = document.getElementById('closeModal');

        text.textContent = message;
        modal.classList.remove('hidden');

        const cleanup = () => {
          modal.classList.add('hidden');
          yesBtn.removeEventListener('click', onYes);
          noBtn.removeEventListener('click', onNo);
          closeBtn.removeEventListener('click', onClose);
        };

        const onYes = () => { cleanup(); resolve(true); };
        const onNo = () => { cleanup(); resolve(false); };
        const onClose = () => { cleanup(); resolve(false); };

        yesBtn.addEventListener('click', onYes);
        noBtn.addEventListener('click', onNo);
        closeBtn.addEventListener('click', onClose);
      });
    }

    async function handleBlockUnblock(event) {
      const button = event.target;
      const userId = button.getAttribute('data-userid');
      const username = button.getAttribute('data-username') || 'this user';
      const block = button.classList.contains('block');
      const action = block ? 'block' : 'unblock';

      const confirmed = await showConfirmModal(`Are you sure you want to ${action} ${username}?`);
      if (!confirmed) return;

      try {
        const res = await fetch(`${API_URL}/admin/block/${userId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
          },
          body: JSON.stringify({ block }),
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || data.message || 'Failed to update user');

        showMessage(data.message, 'success');
        fetchUsers(); 
        fetchRecentActions(); 
      } catch (err) {
        showMessage(err.message, 'error');
      }
    }

    //  Fetch and display metrics
    async function fetchMetrics() {
      try {
        const res = await fetch(`${API_URL}/admin/metrics`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Failed to load metrics');
        const data = await res.json();
        const metricsDiv = document.getElementById('metrics');

        metricsDiv.innerHTML = `
          <p><strong>Total Users:</strong> ${data.userCount}</p>
          <p><strong>Total Tasks:</strong> ${data.taskCount}</p>
          <h4>Tasks by Status:</h4>
          <ul>
            ${data.taskStatusCounts.map(s => `<li>${s.status}: ${s.count}</li>`).join('')}
          </ul>
        `;
      } catch (err) {
        showMessage('Error loading metrics: ' + err.message, 'error');
      }
    }

    async function fetchRecentActions() {
  try {
    const res = await fetch(`${API_URL}/admin/user-actions`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!res.ok) throw new Error('Failed to load actions');

    const actions = await res.json();
    const list = document.getElementById('actions-list');
    list.innerHTML = '';

    const now = Date.now();
    const twentyFourHoursAgo = now - (24 * 60 * 60 * 1000); 

    // Filter actions from last 24 hours
    const recentActions = actions.filter(log => {
      const actionTime = new Date(log.timestamp).getTime();
      return actionTime >= twentyFourHoursAgo;
    });

    if (recentActions.length === 0) {
      list.innerHTML = '<li>No actions in the last 24 hours.</li>';
      return;
    }

    recentActions.forEach(log => {
      const li = document.createElement('li');
      li.textContent = `${log.username} â†’ ${log.action} @ ${new Date(log.timestamp).toLocaleString()}`;
      list.appendChild(li);
    });
  } catch (err) {
    showMessage('Error loading actions: ' + err.message, 'error');
  }
}


    //  Logout
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('token');
      localStorage.removeItem('username');
      localStorage.removeItem('role');
      window.location.href = 'home.html';
    });

    //  Init
    fetchUsers();
    fetchMetrics();
    fetchRecentActions();
  </script>
</body>
</html>


























 
























 








 
























 
































 
























 

























 








 
























 
































 
























 







